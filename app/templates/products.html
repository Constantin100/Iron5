{% extends 'base.html' %}

{% block title %}Продукты{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('home') }}">Главная</a> / Продукты
{% endblock %}

{% block content %}
<h2>Наши продукты</h2>
<p>Здесь вы можете увидеть список наших продуктов.</p>

<!-- Список продуктов -->
<div id="product-list">
    <ul id="products">
        {% for product in products %}
            <li>
                <h3><a href="{{ url_for('product_detail', product_id=product.id) }}">{{ product.name }}</a></h3>
                {% if product.images %}
                    <img src="{{ product.images[0] }}" alt="{{ product.name }}">
                {% endif %}
                <p>{{ product.description }}</p>
                <p>Цена: {{ product.price }} руб.</p>
                <p>Наличие: {{ product.in_stock }}</p>
            </li>
        {% endfor %}
    </ul>
    <p id="no-products-message" style="display: none;">Продуктов из данной категории нет.</p>
</div>

<script>
    // Получаем категорию из URL
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category');
    console.log('Категория:', category); // Отладочное сообщение
    if (category) {
        loadProducts(category); // Загружаем продукты по категории
    } else {
        loadProducts(); // Загружаем все продукты, если категория не указана
    }

    function loadProducts(category = '') {
        console.log('Загрузка продуктов для категории:', category); // Отладочное сообщение
        fetch(`/api/products?category=${category}`)
            .then(response => {
                console.log('Ответ от API:', response); // Отладочное сообщение
                return response.json();
            })
            .then(data => {
                console.log('Полученные данные:', data); // Отладочное сообщение
                const productList = document.getElementById('products');
                const noProductsMessage = document.getElementById('no-products-message');
                productList.innerHTML = ''; // Очистить список

                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        console.log('Обработка продукта:', product); // Отладочное сообщение
                        const li = document.createElement('li');
                        const productUrl = `/product/${product.id}`;
                        console.log('URL продукта:', productUrl); // Отладочное сообщение
                        li.innerHTML = `
                            <h3><a href="${productUrl}">${product.name}</a></h3>
                            ${product.images.length > 0 ? `<img src="${product.images[0]}" alt="${product.name}">` : ''}
                            <p>${product.description}</p>
                            <p>Цена: ${product.price} руб.</p>
                            <p>Наличие: ${product.in_stock}</p>
                        `;
                        productList.appendChild(li);
                    });
                    noProductsMessage.style.display = 'none'; // Скрыть сообщение
                } else {
                    noProductsMessage.style.display = 'block'; // Показать сообщение
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки продуктов:', error);
                const noProductsMessage = document.getElementById('no-products-message');
                noProductsMessage.style.display = 'block'; // Показать сообщение в случае ошибки
            });
    }
</script>
{% endblock %}